{% extends "base.html" %}
{% block title %}Your Cart{% endblock %}
{% block content %}
<h3>Your Cart</h3>
{% if cart.items.all %}
  <table class="table">
    <thead><tr><th>Product</th><th>Price</th><th>Qty</th><th>Subtotal</th><th></th></tr></thead>
    <tbody>
      {% for item in cart.items.all %}
      <tr>
        <td>
          <div class="d-flex align-items-center">
            {% if item.product.image %}
              <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" style="width: 50px; height: 50px; object-fit: cover; margin-right: 10px;">
            {% endif %}
            <div>
              <strong>{{ item.product.name }}</strong>
              <br><small class="text-muted">{{ item.product.category.name }}</small>
            </div>
          </div>
        </td>
        <td>₹{{ item.product.price }}</td>
        <td><input class="form-control qty-input" data-id="{{ item.id }}" value="{{ item.quantity }}" type="number" min="1" max="99" style="width:80px;"></td>
        <td class="item-sub">₹{% widthratio item.product.price 1 item.quantity %}</td>
        </td>
        <td><button class="btn btn-sm btn-outline-danger remove-item" data-id="{{ item.id }}">Remove</button></td>
      </tr>
      {% endfor %}
      <tr>
        <td colspan="3" class="text-end"><strong>Total</strong></td>
        <td colspan="2"><strong>₹<span id="cart-total">0.00</span></strong></td>
      </tr>
    </tbody>
  </table>
  {% if request.user.is_authenticated %}
    <a href="{% url 'core:checkout' %}" class="btn btn-pjp">Proceed to Checkout</a>
  {% else %}
    <p>Please <a href="{% url 'core:login' %}">login</a> (guest cart will merge on login).</p>
  {% endif %}
{% else %}
  <p>Your cart is empty.</p>
  <a href="{% url 'core:product_list' %}" class="btn btn-outline-secondary">Continue Shopping</a>
{% endif %}

<script>
// Complete product prices mapping for all products
const PRICES = {
  // Home page and All Products section
  '1': 110,   // Fancy Bangle 1
  '2': 130,   // Fancy Bangle 2  
  '3': 15,    // Carry Bag 1
  '4': 900,   // Display Toys 1
  '5': 900,   // Display Toys 1 (duplicate from home)
  '6': 1500,  // Display Toys 2 (from home)
  '7': 68,    // Fancy Purse set 1 (from home)
  '8': 175,   // Wall clock (from home)
  
  // Bangles & Half set category (IDs 11-22)
  '11': 110,  // Bangles 1
  '12': 130,  // Bangles 2
  '13': 120,  // Bangles 3
  '14': 140,  // Bangles 4
  '15': 115,  // Bangles 5
  '16': 125,  // Bangles 6
  '17': 135,  // Bangles 7
  '18': 145,  // Bangles 8
  '19': 155,  // Bangles 9
  '20': 165,  // Bangles 10
  '21': 175,  // Bangles 11
  '22': 185,  // Bangles 12
  
  // Carry bags category (IDs 31-41)
  '31': 15,   // Carry Bag 1
  '32': 20,   // Carry Bag 2
  '33': 18,   // Carry Bag 3
  '34': 25,   // Carry Bag 4
  '35': 22,   // Carry Bag 5
  '36': 28,   // Carry Bag 6
  '37': 30,   // Carry Bag 7
  '38': 32,   // Carry Bag 8
  '39': 35,   // Carry Bag 9
  '40': 38,   // Carry Bag 10
  '41': 40,   // Carry Bag 11
  
  // Fancy carry bag category (IDs 51-62)
  '51': 45,   // Fancy Carry Bag 1
  '52': 50,   // Fancy Carry Bag 2
  '53': 48,   // Fancy Carry Bag 3
  '54': 55,   // Fancy Carry Bag 4
  '55': 52,   // Fancy Carry Bag 5
  '56': 58,   // Fancy Carry Bag 6
  '57': 60,   // Fancy Carry Bag 7
  '58': 62,   // Fancy Carry Bag 8
  '59': 65,   // Fancy Carry Bag 9
  '60': 68,   // Fancy Carry Bag 10
  '61': 70,   // Fancy Carry Bag 11
  '62': 75,   // Fancy Carry Bag 12
  
  // Fancy Purse set 1×3 category (IDs 71-75)
  '71': 68,   // Fancy Purse Set 1
  '72': 72,   // Fancy Purse Set 2
  '73': 75,   // Fancy Purse Set 3
  '74': 78,   // Fancy Purse Set 4
  '75': 80,   // Fancy Purse Set 5
  
  // Purse category (IDs 81-88)
  '81': 85,   // Purse 1
  '82': 90,   // Purse 2
  '83': 88,   // Purse 3
  '84': 95,   // Purse 4
  '85': 92,   // Purse 5
  '86': 98,   // Purse 6
  '87': 100,  // Purse 7
  '88': 105,  // Purse 8
  
  // Wall clock category (IDs 91-98)
  '91': 175,  // Wall Clock 1
  '92': 180,  // Wall Clock 2
  '93': 185,  // Wall Clock 3
  '94': 190,  // Wall Clock 4
  '95': 195,  // Wall Clock 5
  '96': 200,  // Wall Clock 6
  '97': 205,  // Wall Clock 7
  '98': 210,  // Wall Clock 8
  
  // Display toys category (IDs 101-115)
  '101': 900,  // Display Toys 1
  '102': 850,  // Display Toys 2
  '103': 950,  // Display Toys 3
  '104': 920,  // Display Toys 4
  '105': 880,  // Display Toys 5
  '106': 1000, // Display Toys 6
  '107': 970,  // Display Toys 7
  '108': 930,  // Display Toys 8
  '109': 990,  // Display Toys 9
  '110': 1050, // Display Toys 10
  '111': 1020, // Display Toys 11
  '112': 980,  // Display Toys 12
  '113': 1100, // Display Toys 13
  '114': 1080, // Display Toys 14
  '115': 1150  // Display Toys 15
};

// Test function to verify input is working
function testInput() {
  console.log("Testing quantity inputs...");
  document.querySelectorAll('.qty-input').forEach(function(input, index) {
    console.log(`Input ${index}: value=${input.value}, id=${input.dataset.id}`);
    input.addEventListener('focus', function() {
      console.log('Input focused:', this.value);
    });
    input.addEventListener('blur', function() {
      console.log('Input blurred:', this.value);
    });
  });
}

// Update totals on page load
document.addEventListener('DOMContentLoaded', function() {
  // Test the inputs
  testInput();
  
  // Set correct prices for products that use dynamic pricing
  document.querySelectorAll('.product-price').forEach(function(priceSpan) {
    const productId = priceSpan.dataset.productId;
    const price = PRICES[productId] || 0;
    priceSpan.textContent = price;
  });
  
  // Initial total calculation
  updateCartTotals();
});

// Function to calculate totals (called by cart.js as well)
function updateCartTotals() {
  let cartTotal = 0;
  
  document.querySelectorAll('.item-sub').forEach(function(subtotalCell) {
    const row = subtotalCell.closest('tr');
    const quantityInput = row.querySelector('.qty-input');
    const quantity = parseInt(quantityInput.value) || 0;
    
    // Check if this is a dynamic price item
    const subtotalSpan = subtotalCell.querySelector('span[data-product-id]');
    if (subtotalSpan) {
      const productId = subtotalSpan.dataset.productId;
      const price = PRICES[productId] || 0;
      const subtotal = price * quantity;
      subtotalSpan.textContent = subtotal.toFixed(2);
      cartTotal += subtotal;
    } else {
      // For fixed price items, calculate from the price cell
      const priceCell = row.querySelector('td:nth-child(2)');
      const priceText = priceCell.textContent.replace('₹', '').trim();
      const price = parseFloat(priceText) || 0;
      const subtotal = price * quantity;
      subtotalCell.textContent = subtotal;
      cartTotal += subtotal;
    }
  });
  
  // Update the total display
  const totalElement = document.getElementById('cart-total');
  if (totalElement) {
    totalElement.textContent = cartTotal.toFixed(2);
  }
}
</script>

{% endblock %}
